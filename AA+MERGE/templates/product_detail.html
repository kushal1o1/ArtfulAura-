{% extends "base.html" %}
{% load custom_filters %}
{% block content %}

  <main class="mt-5 pt-4">
    <div class="container dark-grey-text mt-5">

      <!--Grid row-->
      <div class="row wow fadeIn">

        <!--Grid column-->
        <div class="col-md-6 mb-4">

          <img src="{{ object.image.url }}" class="img-fluid" style="height:500px;" alt="">

        </div>
        <!--Grid column-->

        <!--Grid column-->
        <div class="col-md-6 mb-4">

          <!--Content-->
          <div class="p-4">
            <h3 class="fw-bold mb-3">{{object.title}}</h3>
            <div class="mb-3">
              <a href="">
                <span class="badge purple mr-1">{{ object.get_category_display }}</span>
              </a>
            </div>
            <div class="rating mb-3">
              {% if avg_rating  %}
             {{avg_rating}}

          {% for i in 5|times%}
          {% if i < full_stars %}
              <i class="fas fa-star text-warning"></i>
          {% elif i == full_stars and has_half_star %}
              <i class="fas fa-star-half-alt text-warning"></i>
          {% else %}
              <i class="far fa-star text-warning"></i>
          {% endif %}
      {% endfor %}
                        <span>({{review_count}} Reviews)</span>
                    </div>
                    {% else%}
                    {% for i in 5|times%}
                    <i class="fas fa-star text-warning"></i>
                {% endfor %}
                              <span>( No Reviews Yet)</span>
                          </div>
                        {% endif %}


            <p class="lead">
              {% if object.discount_price %}
              <span class="mr-1">
                <del>${{ object.price }}</del>
              </span>
              <span>${{ object.discount_price }}</span>
              {% else %}
              <span>${{ object.price }}</span>
              {% endif %}
            </p>

            <p class="lead font-weight-bold">Description</p>

            <p>{{ object.description }}</p>

            <a href="{{ object.get_add_to_cart_url }}" class="btn btn-primary btn-md my-0 p">
              Add to cart
              <i class="fas fa-shopping-cart ml-1"></i>
            </a>
            <a href="{{ object.get_remove_from_cart_url }}" class="btn btn-danger btn-md my-0 p">
              Remove from cart
            </a>

          </div>
          <!--Content-->

        </div>
        <!--Grid column-->

      </div>
      <!--Grid row-->

      <hr>

      <!--Grid row-->
      <div class="row d-flex justify-content-center wow fadeIn">

        <!--Grid column-->
        <div class="col-md-6 text-center">

          <h4 class="my-4 h4">Additional information</h4>

          <p>{{object.Additional_information}}</p>

        </div>
        <!--Grid column-->

      </div>
      <!--Grid row-->

      <!--Grid row-->
     
    </div>
  </main>
  <hr>
  <div class="container">
    <div class="col-lg-8 container">
        <h4 class="fw-bold">Leave a Review</h4>
        <form id="reviewForm" method="POST" action="submit_review/">
          {% csrf_token %}
            <div class="mb-3">
                <label for="reviewText" class="form-label">Your Review</label>
                <textarea class="form-control" id="reviewText" rows="4" placeholder="Write your review" name="message" required></textarea>
            </div>
            <div class="mb-3">
              <label for="reviewRating" class="form-label">Rating</label>
              <div class="star-rating">
                  <!-- Display 5 stars with empty state initially -->
                  {% for i in 5|times %}
                      <span class="star far fa-star text-warning " data-value="{{ i }}" onclick="selectRating({{ i }})"></span>
                  {% endfor %}
              </div>
              <!-- Hidden input to store the rating value -->
              <input type="hidden" id="reviewRating" name="rating" value="0" required>
          </div>
          
          <script>
              // Function to handle star click and update the rating
              function selectRating(rating) {
                  // Update the hidden input with the selected rating value
                  document.getElementById('reviewRating').value = rating+1;
          
                  // Select all star elements
                  const stars = document.querySelectorAll('.star-rating .star');
          
                  // Loop over each star and add or remove the 'selected' class based on rating
                  stars.forEach((star, index) => {
                      if (index <= rating) {
                          star.classList.add('fas');
                      } else {
                          star.classList.remove('fas');  // Remove highlight for stars above the rating
                      }
                  });
              }
          </script>

            <button type="submit" class="btn btn-primary">Submit Review</button>
        </form>
        <h3>Reviews</h3>
        <ul class="list-group container">
            {% for review in reviews %}
                <li class="list-group-item">
                    <strong>@{{ review.user.username }}</strong>
                    <div class="stars">
                      {% for i in 5|times %}
                      <span class=" fa-star text-warning {% if i < review.rating %} fas{% else%} far{% endif %}"></span>

                      {% endfor %}
                  </div>
                    <p>{{ review.message }}</p>
                    <button class="btn btn-link" data-toggle="collapse" data-target="#reply-form-{{ review.id }}">Reply</button>
                    
                    <div id="reply-form-{{ review.id }}" class="collapse">
                        <form method="POST"  method="POST" action="submit_review/">
                            {% csrf_token %}
                            <input type="hidden" name="parent_review" value="{{ review.id }}">
                            {{ form.message.label }} <br>
                            <textarea name="message" class="form-control" placeholder="Your reply..." required></textarea>
                            <button type="submit" class="btn btn-primary">Submit Reply</button>
                        </form>
                    </div>
                    {% if review.replies.all%}
                    <ul class="container ">

                        {% for reply in review.replies.all %}
                            <li class="list-group-item  card-body text-start">
                                <strong>@{{ reply.user.username }}</strong>
                                <p>{{ reply.message }}</p>
                                
                            </li>
                        {% endfor %}
                    </ul>
                    {% endif %}
                </li>
            {% endfor %}
        </ul>
    </div>
</div>



{% comment %} TRY {% endcomment %}





<script src="https://code.jquery.com/jquery-3.5.1.slim.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/@popperjs/core@2.9.3/dist/umd/popper.min.js"></script>
<script src="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/js/bootstrap.min.js"></script>
{% comment %} TRY end {% endcomment %}

{% endblock content %}
